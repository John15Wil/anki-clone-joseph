# 云同步功能测试指南

## ✅ 已完成的功能

### 1. 用户认证系统
- ✅ 邮箱注册/登录
- ✅ 用户会话管理
- ✅ 自动创建用户配置文件
- ✅ 登录/退出功能

### 2. 数据同步引擎
- ✅ 双向同步（本地 ↔ 云端）
- ✅ 冲突解决（基于时间戳）
- ✅ 自动同步（每5分钟）
- ✅ 手动同步按钮

### 3. 同步内容
- ✅ 卡组（Decks）
- ✅ 卡片（Cards）
- ✅ 复习记录（Card Reviews）
- ✅ 学习记录（Study Logs）

### 4. 用户界面
- ✅ 登录/注册页面
- ✅ 云同步状态徽章
- ✅ 同步进度指示器
- ✅ 用户邮箱显示
- ✅ 退出登录按钮

---

## 🧪 完整测试流程

### 测试准备

**开发服务器：** http://localhost:5173

**测试账号建议：**
- 使用真实邮箱（用于接收确认邮件）
- 密码至少6个字符

---

### 第 1 步：注册新账号

1. **访问应用**
   ```
   http://localhost:5173
   ```

2. **点击"登录"按钮**
   - 页面右上角
   - 会跳转到 `/auth` 页面

3. **切换到注册模式**
   - 点击"没有账号？立即注册"

4. **填写注册信息**
   - 邮箱：your@email.com
   - 密码：至少6个字符
   - 确认密码：相同

5. **提交注册**
   - 点击"注册账号"
   - 应该看到：✅ "注册成功！请检查邮箱完成验证。"

6. **检查邮箱**
   - 打开邮箱收件箱
   - 查找来自 Supabase 的确认邮件
   - 点击确认链接（可能会打开 Supabase 页面）

---

### 第 2 步：登录账号

1. **返回应用**
   - 访问 http://localhost:5173/auth

2. **登录**
   - 输入注册的邮箱和密码
   - 点击"登录"

3. **验证登录成功**
   - 应该自动跳转到首页
   - 右上角显示"退出登录"按钮
   - 标题下方显示："已登录：your@email.com"
   - 标题旁边显示同步状态徽章

---

### 第 3 步：测试数据上传到云端

1. **创建新卡组**
   - 点击"新建卡组"
   - 名称：测试卡组 A
   - 描述：用于测试云同步
   - 点击"创建"

2. **添加卡片**
   - 进入刚创建的卡组
   - 点击"添加卡片"
   - 正面：What is React?
   - 背面：A JavaScript library for building user interfaces
   - 点击"添加"
   - 再添加2-3张卡片

3. **触发同步**
   - 点击标题旁的同步状态徽章
   - 点击"立即同步"
   - 应该看到：旋转的同步图标
   - 等待几秒后显示：✅ "已同步"

4. **验证数据已上传**
   - 打开 Supabase Dashboard
   - 访问：https://supabase.com/dashboard
   - 进入您的项目
   - 点击左侧 **Table Editor**
   - 查看表：
     - `decks` 表应该有1条记录（测试卡组 A）
     - `cards` 表应该有3-4条记录
   - 所有记录的 `user_id` 应该是您的用户ID

---

### 第 4 步：测试多设备同步

**方案 A：使用无痕模式模拟第二个设备**

1. **打开无痕窗口**
   - Chrome: Ctrl+Shift+N (Windows) / Cmd+Shift+N (Mac)
   - 访问：http://localhost:5173

2. **登录相同账号**
   - 点击"登录"
   - 使用相同的邮箱和密码

3. **等待自动同步**
   - 登录后会自动触发同步
   - 或点击"立即同步"

4. **验证数据已下载**
   - 应该看到："测试卡组 A"
   - 点击进入卡组
   - 应该看到之前创建的3-4张卡片

5. **在设备2创建新数据**
   - 创建新卡组："测试卡组 B"
   - 添加2-3张新卡片
   - 点击"立即同步"

6. **回到设备1（原窗口）**
   - 点击"立即同步"
   - 刷新页面
   - 应该看到："测试卡组 B"和新卡片

**方案 B：使用另一台真实设备**

1. **在手机/平板上访问**
   - 需要在同一网络
   - 获取电脑IP地址
   - 访问：http://[你的IP]:5173
   - 例如：http://192.168.1.100:5173

2. **登录相同账号**
   - 重复上述测试流程

---

### 第 5 步：测试学习记录同步

1. **开始学习（设备1）**
   - 点击卡组的"开始学习"
   - 完成几张卡片的学习
   - 给出不同的评分（困难、中等、简单）

2. **同步学习记录**
   - 学习完成后，返回首页
   - 点击"立即同步"

3. **在设备2查看**
   - 切换到无痕窗口（或另一设备）
   - 点击"立即同步"
   - 点击"统计"查看学习数据
   - 应该看到刚才的学习记录

4. **查看数据库**
   - Supabase → Table Editor → `study_logs`
   - 应该有学习记录
   - 包含：card_id, rating, time_spent, timestamp

---

### 第 6 步：测试冲突解决

1. **断开设备2的网络**
   - 关闭 WiFi（或在无痕窗口中）

2. **设备2离线修改**
   - 编辑"测试卡组 A"的名称 → "测试卡组 A (设备2修改)"
   - 数据保存在本地

3. **设备1在线修改**
   - 编辑"测试卡组 A"的名称 → "测试卡组 A (设备1修改)"
   - 点击"立即同步"（会上传到云端）

4. **恢复设备2网络**
   - 连接 WiFi
   - 点击"立即同步"

5. **验证冲突解决**
   - 系统会保留最后修改的版本（基于 `updated_at` 时间戳）
   - 两个设备应该显示相同的名称

---

### 第 7 步：测试自动同步

1. **等待5分钟**
   - 系统会自动触发同步
   - 观察同步状态徽章的变化

2. **创建新数据**
   - 在任一设备创建新卡组/卡片
   - 不手动同步

3. **等待另一设备自动同步**
   - 最多等5分钟
   - 应该自动出现新数据

---

## 🔍 验证清单

### 用户认证
- [ ] 可以注册新账号
- [ ] 收到确认邮件
- [ ] 可以登录
- [ ] 显示用户邮箱
- [ ] 可以退出登录

### 数据上传
- [ ] 卡组上传到云端
- [ ] 卡片上传到云端
- [ ] 复习记录上传到云端
- [ ] 学习记录上传到云端

### 数据下载
- [ ] 从云端下载卡组
- [ ] 从云端下载卡片
- [ ] 从云端下载复习记录
- [ ] 从云端下载学习记录

### 多设备同步
- [ ] 设备1的数据出现在设备2
- [ ] 设备2的数据出现在设备1
- [ ] 学习进度同步
- [ ] 学习记录同步

### 同步状态
- [ ] 显示"同步中..."
- [ ] 显示"已同步"
- [ ] 显示上次同步时间
- [ ] 手动同步按钮工作
- [ ] 自动同步（5分钟）工作

### 冲突解决
- [ ] 相同数据的修改冲突正确解决
- [ ] 最后修改的版本被保留
- [ ] 没有数据丢失

---

## 🐛 常见问题排查

### 问题 1：注册后没收到邮件
**解决方案：**
- 检查垃圾邮件文件夹
- 在 Supabase Dashboard → Authentication → Users 查看用户是否创建
- 可以在 Supabase 中手动确认邮箱

### 问题 2：同步按钮一直转圈
**解决方案：**
- 打开浏览器控制台 (F12)
- 查看 Console 标签的错误信息
- 检查网络连接
- 验证 Supabase 凭证是否正确

### 问题 3：数据没有同步
**解决方案：**
- 确认已登录
- 点击"立即同步"
- 检查控制台是否有错误
- 验证 Supabase RLS 策略是否正确

### 问题 4：多设备看到的数据不一致
**解决方案：**
- 两个设备都点击"立即同步"
- 刷新页面
- 检查两个设备是否登录同一账号

### 问题 5：控制台显示权限错误
**解决方案：**
- 检查 Supabase 的 Row Level Security 策略
- 确认 SQL 脚本完全执行成功
- 在 Supabase SQL Editor 中重新运行 `supabase-schema.sql`

---

## 📊 性能指标

### 同步速度（参考值）
- 10个卡组 + 100张卡片：< 2秒
- 1000条学习记录：< 3秒
- 完整首次同步：< 5秒

### 自动同步间隔
- 默认：5分钟
- 登录时：立即同步
- 可调整：修改 `cloudSync.ts` 中的 `setInterval` 参数

---

## 🎉 测试成功标志

如果以下所有项目都通过，说明云同步功能完全正常：

1. ✅ 可以注册和登录
2. ✅ 本地数据自动上传到云端
3. ✅ 云端数据自动下载到本地
4. ✅ 多设备数据保持一致
5. ✅ 学习进度正确同步
6. ✅ 同步状态正确显示
7. ✅ 自动同步按时触发
8. ✅ 冲突正确解决

---

## 🚀 下一步优化建议

1. **实时同步**
   - 使用 Supabase Realtime 订阅
   - 数据变更立即推送到所有设备

2. **增量同步**
   - 只同步变更的数据
   - 减少网络流量

3. **离线队列**
   - 离线时记录操作
   - 上线后自动同步

4. **同步历史**
   - 记录同步日志
   - 显示同步详情

5. **数据压缩**
   - 大量数据时压缩传输
   - 提高同步速度

---

## 📝 测试日志模板

```
测试日期：2026-01-19
测试人员：[你的名字]
测试环境：Chrome 浏览器

✅ 用户注册：通过
✅ 用户登录：通过
✅ 数据上传：通过
✅ 数据下载：通过
✅ 多设备同步：通过
✅ 学习记录同步：通过
✅ 冲突解决：通过
✅ 自动同步：通过

问题记录：
- 无

备注：
- 云同步功能完全正常
- 同步速度良好
- 用户体验流畅
```

---

## 💡 开始测试

现在打开浏览器，访问 **http://localhost:5173**，开始测试吧！

有任何问题随时查看浏览器控制台（F12）的错误信息。
